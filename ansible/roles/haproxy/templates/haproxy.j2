global
    maxconn 20000
    ulimit-n  40018
    log 127.0.0.1 local0
    daemon

defaults
    timeout connect 5s
    timeout client 30s
    timeout server 30s

frontend fe_https
    bind *:8443 ssl crt /usr/local/etc/haproxy/certs/sou_podman.pem
    bind *:80 
    mode http
    log global
    option httplog
    option dontlognull
    option nolinger
    maxconn 8000

    acl is_vault hdr(host) -i vault.local 
    use_backend vault if is_vault

    acl is_grafana hdr(host) -i grafana.local 
    use_backend grafana if is_grafana
    
    acl is_prometheus hdr(host) -i prometheus.local 
    use_backend prometheus if is_prometheus

backend vault
    mode http
    balance roundrobin
    option httpchk
    server vault1 192.168.50.12:8200 check check-ssl ssl verify none
    
backend grafana
    mode http
    balance roundrobin
    option httpchk
    server grafana1 192.168.50.12:3000 check

backend prometheus
    mode http
    balance roundrobin
    option httpchk
    server prometheus1 192.168.50.12:9090 check
